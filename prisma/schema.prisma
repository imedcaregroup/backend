generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                @id @default(autoincrement())
  email               String?            @unique
  password            String?
  mobileNumber        String?
  otp                 Int?
  name                String?
  surName             String?
  pytroNym            String?
  dob                 DateTime?
  address             String?            @default("None")
  authProvider        String
  googleId            String?
  notificationEnabled Boolean            @default(false)
  country             String?
  gender              String?
  lat                 Float?
  lng                 Float?
  isDeleted           Boolean?           @default(false)
  imageUrl            String?            @default("https://thumbs.dreamstime.com/b/profile-anonymous-face-icon-gray-silhouette-person-male-default-avatar-photo-placeholder-white-background-vector-illustration-106473768.jpg")
  passportUrls        String[]           @default([])
  addresses           Address[]
  orders              Order[]
  tokens              FcmToken[]
  employee            Employee?
  notificationsPivot  UserNotification[]
}

enum PhoneOtpIntent {
  SIGNUP
  PHONE_CHANGE
}

model PhoneOtpCode {
  id          Int            @id @default(autoincrement())
  phone       String
  deviceId    String? // optional device binding (maybe use later to limit OTPs per device)
  intent      PhoneOtpIntent
  codeHash    String
  attempts    Int            @default(0)
  maxAttempts Int            @default(5)
  taskId      String // for tracking with external service
  expiresAt   DateTime
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([phone, intent, expiresAt])
  @@index([expiresAt])
}

model Service {
  id         Int                @id @default(autoincrement())
  iconUrl    String
  name       String
  systemName String?
  categories Category[]
  Order      Order[]
  orders     OrderSubCategory[]
}

model Category {
  id            Int                @id @default(autoincrement())
  iconUrl       String
  name          String
  serviceId     Int
  service       Service            @relation(fields: [serviceId], references: [id])
  Order         Order[]
  orders        OrderSubCategory[]
  subcategories SubCategory[]
}

model SubCategory {
  id                 Int                @id @default(autoincrement())
  iconUrl            String
  name               String
  name_en            String?
  name_az            String?
  name_ru            String?
  systemName         String?
  categoryId         Int
  type               SubCategoryType    @default(NORMAL)
  medicalCategories  MedicalCategory[]
  employeeCategories EmployeeCategory[]
  orderSubCategories OrderSubCategory[] @relation("SubCategoryOrderSubCategories")
  category           Category           @relation(fields: [categoryId], references: [id])
  specialOffers      SpecialOffer[]
}

enum SubCategoryType {
  NORMAL
  SPECIAL_OFFER_ONLY
}

model Medical {
  id                Int                   @id @default(autoincrement())
  iconUrl           String
  imageUrl          String?
  name              String
  lat               Float
  lng               Float
  address           String?
  address_en        String?
  address_ru        String?
  services          String?
  services_en       String?
  services_ru       String?
  type_az           String?
  type_en           String?
  type_ru           String?
  contact           String?
  isActive          Boolean               @default(true)
  tiers             DistancePricingTier[]
  availabilities    Availability[]
  medicalCatrgories MedicalCategory[]
  orders            Order[]
  adminId           Int?
  admin             Admin?                @relation("AdminMedical", fields: [adminId], references: [id])
  employees         Employee[]
  SpecialOffer      SpecialOffer[]
  employeeMedical   EmployeeMedical[]
  HomeServicePolicy HomeServicePolicy?
}

model DistancePricingTier {
  id        Int      @id @default(autoincrement())
  medicalId Int
  minKm     Decimal  @db.Decimal(10, 2)
  maxKm     Decimal? @db.Decimal(10, 2)

  medical            Medical              @relation(fields: [medicalId], references: [id])
  LeadtimeAdjustment LeadtimeAdjustment[]

  @@index([medicalId, minKm, maxKm])
}

model HomeServicePolicy {
  id          Int      @id @default(autoincrement())
  medicalId   Int      @unique
  freeOverAzn Decimal? @db.Decimal(10, 2) // null => use global (e.g., 50)
  isActive    Boolean  @default(true)

  medical Medical @relation(fields: [medicalId], references: [id])
}

model LeadtimeAdjustment {
  id                    Int     @id @default(autoincrement())
  distancePricingTierId Int
  minLeadHours          Int     @default(0) // inclusive
  maxLeadHours          Int? // exclusive; null = open-ended
  feeAzn                Decimal @db.Decimal(10, 2)

  distancePricingTier DistancePricingTier @relation(fields: [distancePricingTierId], references: [id])

  @@index([distancePricingTierId, minLeadHours, maxLeadHours])
}

model MedicalCategory {
  id            Int         @id @default(autoincrement())
  medicalId     Int
  subCategoryId Int
  createdAt     DateTime    @default(now())
  price         Float       @default(0)
  medical       Medical     @relation(fields: [medicalId], references: [id])
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id])
}

model EmployeeCategory {
  id            Int         @id @default(autoincrement())
  employeeId    Int
  subCategoryId Int
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  price         Float       @default(0)
  employee      Employee    @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  subCategory   SubCategory @relation(fields: [subCategoryId], references: [id])

  @@unique([employeeId, subCategoryId])
}

model EmployeeMedical {
  id         Int       @id @default(autoincrement())
  employeeId Int?
  medicalId  Int?
  medical    Medical?  @relation(fields: [medicalId], references: [id])
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, medicalId])
}

model Order {
  id                    Int                @id @default(autoincrement())
  createdAt             DateTime           @default(now())
  serviceId             Int?
  categoryId            Int?
  medicalId             Int?
  userId                Int
  price                 Float              @default(0)
  address               String?
  lat                   Float?
  lng                   Float?
  entrance              String?
  floor                 Int?
  apartment             String?
  intercom              String?
  paymetStatus          String             @default("pending")
  payment_order_id      String?
  orderStatus           String             @default("pending")
  employeeStatus        String             @default("pending")
  declinedReason        String?
  orderDate             DateTime
  additionalInfo        String?
  date                  String?
  endTime               Int?
  startTime             Int?
  fileUrl               String?
  doctor                String?            @db.VarChar(255)
  forAnotherPerson      Boolean?           @default(false)
  forAnotherPersonName  String?
  forAnotherPersonPhone String?
  refounded             Boolean?           @default(false)
  refoundedAmount       Float?             @default(0)
  Category              Category?          @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  medical               Medical?           @relation(fields: [medicalId], references: [id])
  Service               Service?           @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  user                  User               @relation(fields: [userId], references: [id])
  orderSubCategories    OrderSubCategory[]
  adminId               Int?
  admin                 Admin?             @relation("AdminOrder", fields: [adminId], references: [id])
  employeeId            Int?
  employee              Employee?          @relation(fields: [employeeId], references: [id])
  paymentMethod         PaymentMethod?     @default(COD)
  SpecialOffer          SpecialOffer?      @relation(fields: [specialOfferId], references: [id])
  specialOfferId        Int?
}

enum PaymentMethod {
  COD
  Card
}

model OrderSubCategory {
  orderId       Int
  subCategoryId Int
  serviceId     Int
  categoryId    Int
  id            Int         @id @default(autoincrement())
  category      Category    @relation(fields: [categoryId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  order         Order       @relation(fields: [orderId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  service       Service     @relation(fields: [serviceId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subCategory   SubCategory @relation("SubCategoryOrderSubCategories", fields: [subCategoryId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "OrderSubCategory_subCategoryId_to_SubCategory")
}

model Availability {
  id         Int       @id @default(autoincrement())
  createdAt  DateTime  @default(now())
  day        Int
  startTime  Int
  endTime    Int
  medicalId  Int?
  employeeId Int?
  medical    Medical?  @relation(fields: [medicalId], references: [id])
  employee   Employee? @relation(fields: [employeeId], references: [id])
}

model Address {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  shortName String
  city      String
  district  String
  address   String
  userId    Int
  lat       Float?
  lng       Float?
  entrance  String?
  floor     Int?
  apartment String?
  intercom  String?
  user      User     @relation(fields: [userId], references: [id])
}

model FcmToken {
  id     Int    @id @default(autoincrement())
  token  String @unique
  userId Int
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// New Admin model for admin panel authentication
model Admin {
  id        Int       @id @default(autoincrement())
  email     String    @unique
  password  String
  name      String
  role      AdminRole @default(ADMIN)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  medical   Medical[] @relation("AdminMedical")
  orders    Order[]   @relation("AdminOrder")
}

enum AdminRole {
  ADMIN
  SUPER_ADMIN
}

enum EmployeeType {
  DOCTOR
  NURSE
}

model Employee {
  id                 Int                @id @default(autoincrement())
  name               String
  surName            String
  position           String
  about_az           String?
  about_ru           String?
  about_en           String?
  experienceYears_az String?
  experienceYears_ru String?
  experienceYears_en String?
  patientsCount      Int                @default(0)
  type               EmployeeType       @default(NURSE)
  imageUrl           String?
  userId             Int                @unique
  user               User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt          DateTime           @default(now())
  medicalId          Int?
  medical            Medical?           @relation(fields: [medicalId], references: [id])
  availabilities     Availability[]
  employeeCategories EmployeeCategory[]
  Order              Order[]
  medicals           EmployeeMedical[]
  cityId             Int?
  city               City?              @relation(fields: [cityId], references: [id])
}

model Country {
  id      Int     @id @default(autoincrement())
  name_az String?
  name_en String?
  name_ru String

  cities City[]
}

model City {
  id      Int     @id @default(autoincrement())
  name_az String?
  name_en String?
  name_ru String

  countryId Int
  country   Country @relation(fields: [countryId], references: [id])

  employees Employee[]
}

model SpecialOffer {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title_az       String    @default("")
  title_en       String    @default("")
  title_ru       String    @default("")
  description_az String?
  description_en String?
  description_ru String?
  benefits_az    String[]
  benefits_en    String[]
  benefits_ru    String[]
  forWhom_az     String[]
  forWhom_en     String[]
  forWhom_ru     String[]
  imageUrl_az    String    @default("")
  imageUrl_en    String    @default("")
  imageUrl_ru    String    @default("")
  priority       Int       @default(0)
  isActive       Boolean   @default(true)
  startsAt       DateTime?
  endsAt         DateTime?

  medicalId Int
  medical   Medical @relation(fields: [medicalId], references: [id])

  subCategories SubCategory[]

  originalPrice Float? // shown as strikethrough
  price         Float? // final price if you want to lock it
  discountType  DiscountType?
  discountValue Float? // 20 -> 20% if PERCENTAGE, or 20 AZN if FIXED

  orders Order[] // orders created from this offer
}

enum NotificationActionType {
  NONE
  INTERNAL_URL
  EXTERNAL_URL
  ENTITY
}

model Notification {
  id        Int      @id @default(autoincrement())
  title     String
  body      String
  createdAt DateTime @default(now())

  actionType NotificationActionType @default(NONE)

  // If actionType is INTERNAL_URL / EXTERNAL_URL
  actionUrl String?

  // If actionType is ENTITY
  entityType String?
  entityId   String?

  // Optional extra payload (flexible)
  data Json?

  recipients UserNotification[]

  @@index([createdAt(sort: Desc)], map: "idx_notification_created")
}

model UserNotification {
  userId         Int
  notificationId Int
  readAt         DateTime?

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@id([userId, notificationId])
  @@index([userId, readAt], map: "idx_un_user_readat")
  @@index([notificationId], map: "idx_un_notification")
}

enum DiscountType {
  PERCENTAGE
  FIXED
}
